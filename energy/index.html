<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能源管理儀表板</title>
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/apple-touch-icon.png">
    <link rel="shortcut icon" href="../assets/favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- 基礎樣式 --- */
        body { margin: 0; font-family: 'Microsoft JhengHei', 'Heiti TC', sans-serif; overflow: hidden; background-color: #0d1117; color: #c9d1d9; }

        /* --- 框架 UI 樣式  --- */
        #top-banner {
            position: relative; top: 0; left: 0; width: 100%;
            background-color: rgba(0, 0, 0, 0.7); color: white;
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; box-sizing: border-box; z-index: 20;
        }
        #project-title { margin: 0; font-size: 22px; font-weight: 500; margin-left: 15px; }
        #datetime-container { font-size: 16px; }
        #menu-toggle-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0 10px; }
        #sidebar-menu { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background-color: #2c3e50; padding: 20px; box-sizing: border-box; z-index: 1000; transition: left 0.3s ease-in-out; }
        #sidebar-menu.open { left: 0; }
        #sidebar-menu h2 { color: white; margin-top: 50px; border-bottom: 1px solid #465a70; padding-bottom: 10px; }
        #sidebar-menu ul { list-style: none; padding: 0; margin-top: 20px;}
        #sidebar-menu li a { display: block; color: #ecf0f1; text-decoration: none; padding: 15px 10px; border-radius: 4px; transition: background-color 0.2s; }
        #sidebar-menu li a:hover { background-color: #34495e; }
        #close-menu-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 30px; font-weight: bold; line-height: 1; cursor: pointer; }
        #sidebar-menu .system-category > a { font-weight: bold; background-color: #1bdbed; color: white; }
        #sidebar-menu .system-category > a::after { content: '▼'; float: right; transition: transform 0.3s; }
        #sidebar-menu .system-category.active > a::after { transform: rotate(180deg); }
        .floor-submenu { list-style: none; padding-left: 20px; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        #back-to-home-btn { margin-top: 20px; padding-top: 20px !important; border-top: 1px solid #465a70; font-weight: bold; color: #1bdbed !important; }
        #back-to-home-btn:hover { background-color: #34495e !important; color: #1fecff !important; }
        #sidebar-menu li a[href*="energy"] {
            margin-bottom: 18px; /* 能源管理按鈕下方間距 */
        }
        /* 此頁面沒有3D操控，隱藏不需要的按鈕和提示 */
        #ui-container, #controls-helper, #floor-indicator { display: none; }

        /* --- ★★★ 儀表板內容區的專屬樣式 ★★★ --- */
        #content-wrapper {
            position: absolute;
            top: 70px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            padding: 20px;
            overflow-y: auto; /* ★ 當內容超高時，自動顯示垂直滾動條 */
        }

        /* 數據區塊，有下間距 */
        .data-section {
            margin-bottom: 30px;
        }       

        /* 區塊標題樣式 */
        .section-title {
            font-size: 28px;
            font-weight: 500;
            color: #d6d6d6;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
            margin-top: 0;
                      
        }
        .data-section:first-of-type .section-title {
            border-bottom: none; /* ★ 只移除這個標題的底線 */
            margin-bottom: 10px; /* 稍微縮小與下方頁籤的間距 */
        }

        /* 數據卡片網格的樣式 */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        .data-card {
            background-color: #161b22;
            border: 1px solid #5d6876;
            border-radius: 8px;
            padding: 25px;
        }
        .data-card .title { font-size: 20px; color: #d1dff0; margin-bottom: 10px; }
        .data-card .value { font-size: 32px; font-weight: bold; color: #52a0fa; }
        .data-card .unit { font-size: 16px; margin-left: 8px; }

        /* 圖表容器的樣式 */
        .chart-container {
            margin-top: 20px;
        }

        /* 水力監控區塊的佈局 */
        .water-grid {
            display: grid; /* 使用 Grid 來做左右佈局 */
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }
        .water-summary {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
                
        /* 圖表尺寸的包裝層 */
        .chart-wrapper {
            position: relative;
            height: 350px;
            width: 100%;
        }
        /* 1. 設定整個滾動條的寬度 */
        #content-wrapper::-webkit-scrollbar {
            width: 12px;
        }

        /* 2. 設定滾動條的軌道 (背景) */
        #content-wrapper::-webkit-scrollbar-track {
            background: #161b22; /* 使用與卡片背景一致或稍暗的顏色 */
            border-radius: 5px;
        }

        /* 3. 設定滾動條的滑塊 (可以拖動的部分) */
        #content-wrapper::-webkit-scrollbar-thumb {
            background-color: #4F565E; 
            border-radius: 5px;
            border: 3px solid #161b22; /* 創造內邊距的效果 */
        }

        /* 4. 設定滑鼠懸停在滑塊上時的樣式 */
        #content-wrapper::-webkit-scrollbar-thumb:hover {
            background-color: #686E75; /* 懸停時變亮，提供反饋 */
        }
        /* --- 針對 Firefox 的相容性設定 --- */
        #content-wrapper {
            scrollbar-width: thin; /* 可以是 'auto', 'thin', 'none' */
            scrollbar-color: #75b3f9 #5e6165; /* 依序是「滑塊顏色」和「軌道顏色」 */
        }
        .card-main-content {
            display: flex;
            justify-content: space-between; /* 讓主數據和分支數據左右兩端對齊 */
            align-items: flex-end;      /* 底部對齊 */
            margin-top: 10px;
        }

        /* 分支數據容器的樣式 */
        .sub-data-container {
            display: flex;
            gap: 20px; /* 讓住宅區和辦公區之間有一些間距 */
            font-size: 18px;
            color: #c1c1c1;
        }

        /* 分支數據項目的樣式 */
        .sub-data-item {
            display: flex;
            flex-direction: column; /* 讓標題和數值垂直排列 */
            align-items: center; /* 水平置中 */
        }

        /* 分支數據數值的樣式 */
        .sub-value {
            font-weight: bold;
            color: #ffffff;
            margin-top: 5px;
        }

        /* 圖表切換按鈕的容器樣式 */
        .chart-toggle {
            display: flex;
            justify-content: center;            
        }

        .data-toggle-group {
            width: 20%;       /* ★ 設定寬度*/
            margin: 0 auto;   /* ★ 讓這個按鈕組水平置中 */
            margin-bottom: 20px; /* 保持與下方卡片的間距 */
        }

        /* 切換按鈕的樣式 */
        .toggle-btn {
            background-color: transparent;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1; /* ★ 讓所有按鈕等量瓜分空間，實現均分寬度 */
            text-align: center; /* 確保文字在變寬的按鈕中依然置中 */
        }

        /* 讓容器內的按鈕平均分配這個寬度 */
        .section-header .toggle-btn {
            flex: 1;         
        }

        .toggle-btn:first-child {
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
        }
        .toggle-btn:last-child {
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
            border-left: none; /* 讓按鈕之間無縫連接 */
        }

        /* 當前選中的按鈕的樣式 */
        .toggle-btn.active {
            background-color: #58a6ff;
            color: white;
            border-color: #58a6ff;
        }

        /* 移除標題連結的預設樣式 */
        #home-link-title {
            color: inherit; /* 繼承父元素(header)的文字顏色，也就是白色 */
            text-decoration: none; /* 移除底線 */
            position: absolute; /* ★ 1. 讓標題脫離文檔流，進行絕對定位 */
            left: 50%;          /* ★ 2. 將標題的左側邊緣，對齊到父容器的中心線 */
            top: 50%;           /* ★ 3. 將標題的頂部邊緣，對齊到父容器的中心線 */
            transform: translate(-50%, -50%); /* ★ 4. 將標題向左、向上移動自身寬高的一半，實現完美置中 */
            width: 60%; /* 設定一個寬度，防止標題在小螢幕上與兩側元素重疊 */
            text-align: center;
        }     

        /* 頁籤導覽列的樣式 */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid #30363d;
            margin-bottom: 20px;
        }

        /* 頁籤連結的樣式 */
        .tab-link {
            padding: 10px 20px;
            color: #8b949e; /* 未選中時的顏色 */
            text-decoration: none;
            border-bottom: 2px solid transparent; /* 預設的底線是透明的 */
            margin-bottom: -1px; /* 讓選中的底線能蓋過容器的底線 */
            transition: color 0.2s, border-color 0.2s;
        }

        .tab-link:hover {
            color: #c9d1d9; /* 滑鼠懸停時的顏色 */
        }

        /* 當前選中的頁籤的樣式 */
        .tab-link.active {
            color: #ffffff;
            font-weight: 600;
            border-bottom-color: #ff5c38; /* 類似 GitHub 的橘色底線 */
        }

        /* 頁籤內容面板的樣式 */
        .tab-content {
            display: none; /* 預設所有內容都隱藏 */
        }

        /* 當前顯示的內容面板的樣式 */
        .tab-content.active {
            display: block; /* 只顯示帶有 active class 的內容 */
        }
        .analysis-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; }
        .analysis-cards-container { display: flex; flex-direction: column; gap: 15px; }
        .data-card.small { padding: 15px; }
        .data-card.small .title { font-size: 15px; }
        .data-card.small .value { font-size: 26px; }
        .data-card.small .unit { font-size: 14px; }
        .pie-chart-container { display: flex; align-items: center; justify-content: center; }

        /* 查詢列樣式 */
        .query-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        /*#date-picker {
            background-color: #161b22;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px;
            border-radius: 6px;
            font-family: inherit;
        }*/
        /* 1. 建立一個通用的按鈕 class */
        .query-bar button {
            color: white;
            border: none; /* 移除預設邊框 */
            padding: 9px 16px; /* 調整 padding 讓高度和日期選擇器更一致 */
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px; /* 統一字體大小 */
            transition: background-color 0.2s;
        }

        /* 2. 為「搜尋」按鈕設定專屬顏色 */
        #search-btn {
            background-color: #238636; /* 綠色 */
        }
        #search-btn:hover {
            background-color: #2ea043; /* 懸停時的亮綠色 */
        }

        /* 3. 為「匯出」按鈕設定專屬顏色 */
        #export-btn {
            background-color: #007bff; /* 主題藍色 */
        }
        #export-btn:hover {
            background-color: #0069d9; /* 懸停時的深藍色 */
        }

        /* 結果顯示區樣式 */
        .results-container {
            margin-top: 20px;
        }
        .placeholder-text {
            text-align: center;
            color: #8b949e;
            font-size: 18px;
            padding: 40px 0;
        }
        .hidden {
            display: none !important;
        }

        /* 數據表格樣式 */
        #results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #results-table th, #results-table td {
            padding: 12px 15px;
            border: 1px solid #30363d;
            text-align: left;
        }
        #results-table thead {
            background-color: #161b22;
        }
        #results-table tbody tr:nth-child(even) {
            background-color: #1c2128;
        }
        #results-table tfoot {
            font-size: 1.1em;
            background-color: #161b22;
        }
        #results-table td:last-child {
            text-align: right;
            font-weight: bold;
            color: #58a6ff;
        }

        /* 歷史紀錄頁籤的區塊樣式 */
            .record-block {
            margin-bottom: 30px;
         padding-bottom: 30px;
            border-bottom: 1px solid #30363d;
        }
        .record-block:last-child {
            border-bottom: none;
            margin-bottom: 0;
    }

        /* 區塊內小標題 */
        .block-title {
            color: #8b949e;
            font-weight: 500;
            margin-top: 0;
        }

        /* 日期、月份選擇器的樣式 */
        #date-picker,
        #month-picker {
            background-color: #21262d; /* ★ 使用一個稍亮的背景色 */
            border: 1px solid #58a6ff; /* ★ 使用主題藍色作為邊框，提示可互動 */
            color: #c9d1d9;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 16px;
            color-scheme: dark; /* 盡可能讓彈出的日曆也是深色的 */
        }
        /*icon*/
        .header-right-items {
            display: flex;
            align-items: center; /* 讓日期時間和圖示垂直置中對齊 */
            gap: 15px; /* 在日期時間和圖示之間增加間距 */
        }

        /* 2. 右上角 Logo 圖示的樣式 */
        #logo-icon-right {
            height: 32px; /* 設定圖示的高度 */
            width: 32px;  /* 設定圖示的寬度 */
        }
        /* 頁腳的樣式 */
        #page-footer {
            position: fixed; 
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001; /* 確保它在最上層 (比側邊欄的 1000 還高) */
    
            color: rgba(255, 255, 255, 0.3); /* 半透明的白色文字 */
            font-size: 12px;
    
            /* 確保滑鼠可以穿透它，不會擋住下方的元素 */
            pointer-events: none; 
    
            /* 確保使用者無法選取文字 */
            user-select: none;
            -webkit-user-select: none;
        }

    </style>
</head>
<body>
    <header id="top-banner">
        <button id="menu-toggle-btn" title="展開選單">☰</button>
        <a href="https://workkkkkkez00m.github.io/K-3D-viewer/index.html" id="home-link-title">
            <h1 id="project-title">智慧住宅中央監控系統 </h1>
        </a>
        <div class="header-right-items">
            <div id="datetime-container"></div>
            <img src="../assets/favicon-32x32.png" id="logo-icon-right" alt="系統圖示">
        </div>
    </header>

    <nav id="sidebar-menu">
        <button id="close-menu-btn">&times;</button>
        <h2>系統選單</h2>
        <ul>
            <li class="system-category">
                <a href="#">防盜及求救系統</a>
                <ul class="floor-submenu">
                    <li><a href="../theft_prevention/1f.html">1F</a></li>
                    <li><a href="../theft_prevention/2f.html">2F</a></li>
                    <li><a href="../theft_prevention/3f.html">3F</a></li>
                    <li><a href="../theft_prevention/4f.html">4F</a></li>
                    <li><a href="../theft_prevention/5f.html">5F</a></li>
                </ul>
            </li>
            <li class="system-category">
                <a href="#">攝影監視系統</a>
                <ul class="floor-submenu">
                    <li><a href="../cctv/1f.html">1F</a></li>
                    <li><a href="../cctv/2f.html">2F</a></li>
                    <li><a href="../cctv/3f.html">3F</a></li>
                    <li><a href="../cctv/4f.html">4F</a></li>
                    <li><a href="../cctv/5f.html">5F</a></li>
                </ul>
            </li>
            <li class="system-category">
                <a href="#">門禁保全系統</a>
                <ul class="floor-submenu">
                     <li><a href="../access_control/1f.html">1F</a></li>
                    <li><a href="../access_control/2f.html">2F</a></li>
                    <li><a href="../access_control/3f.html">3F</a></li>
                    <li><a href="../access_control/4f.html">4F</a></li>
                    <li><a href="../access_control/5f.html">5F</a></li>
                </ul>
            </li>
            <li class="system-category">
                <a href="#">影像對講系統</a>
                <ul class="floor-submenu">
                    <li><a href="../video_intercom/1f.html">1F</a></li>
                    <li><a href="../video_intercom/2f.html">2F</a></li>
                    <li><a href="../video_intercom/3f.html">3F</a></li>
                    <li><a href="../video_intercom/4f.html">4F</a></li>
                    <li><a href="../video_intercom/5f.html">5F</a></li>
                </ul>
            </li>
            <li class="system-category">
                <a href="#">消防火警系統</a>
                <ul class="floor-submenu">
                    <li><a href="../fire_alarm/1f.html">1F</a></li>
                    <li><a href="../fire_alarm/2f.html">2F</a></li>
                    <li><a href="../fire_alarm/3f.html">3F</a></li>
                    <li><a href="../fire_alarm/4f.html">4F</a></li>
                    <li><a href="../fire_alarm/5f.html">5F</a></li>
                </ul>
            </li>
            <li class="system-category">
                <a href="#">給排水系統</a>
                <ul class="floor-submenu">
                   <li><a href="../plumbing_drainage/b3f.html">B3F</a></li>                   
                </ul>
            </li>
            <li class="system-category">
                <a href="#">停車管理系統</a>
                <ul class="floor-submenu">
                    <li><a href="../parking_management/b1f.html">B1F</a></li>
                    <li><a href="../parking_management/b2f.html">B2F</a></li>
                    <li><a href="../parking_management/b3f.html">B3F</a></li>                   
                </ul>
            </li>   
            <li><a href="../energy/index.html" style="background-color: #007bff; font-weight: bold;">能源管理儀表板</a></li>
            <li><a href="../elevator_management/index.html" style="background-color: #007bff; font-weight: bold;">電梯監控系統</a></li>
            <li><a id="back-to-home-btn" href="../index.html">‹ 回首頁</a></li>
        </ul>
    </nav>

    <main id="content-wrapper">
        <section class="data-section">
            <h2 class="section-title">電力監控</h2>

            <nav class="tab-nav">
                <a href="#realtime-monitoring" class="tab-link active">即時監控</a>
                <a href="#energy-analysis" class="tab-link">耗能分析</a>
                <a href="#historical-records" class="tab-link">歷史紀錄</a>
            </nav>

            <div class="tab-content-container">        
                <div id="realtime-monitoring" class="tab-content active">
                    <div class="section-header">                          
                        <div class="chart-toggle data-toggle-group">
                            <button id="total-data-btn" class="toggle-btn active" data-zone="total">全區</button>
                            <button id="res-data-btn" class="toggle-btn" data-zone="residential">住宅區</button>
                            <button id="off-data-btn" class="toggle-btn" data-zone="office">辦公區</button>
                        </div>
                    </div>
                    <div class="summary-grid">
                        <div class="data-card">
                            <div class="title">即時用電量</div>
                            <div><span id="realtime-power" class="value">--</span><span class="unit">kW</span></div>
                        </div>
                        <div class="data-card">
                            <div class="title">本日用電總量</div>
                            <div><span id="today-kwh" class="value">--</span><span class="unit">kWh</span></div>
                        </div>
                        <div class="data-card">
                            <div class="title">本月用電總量</div>
                            <div><span id="month-kwh" class="value">--</span><span class="unit">kWh</span></div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-toggle data-toggle-group">
                            <button id="line-chart-btn" class="toggle-btn">總量趨勢</button>
                            <button id="bar-chart-btn" class="toggle-btn active">用量分佈</button>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="hourly-chart"></canvas>
                        </div>
                    </div>    
                </div>

                <!-- ★★★ 「耗能分析」頁籤的新結構 ★★★ -->
                <div id="energy-analysis" class="tab-content">
                    <div class="analysis-grid">
                        <div class="analysis-cards-container">
                            <div class="data-card small"><div class="title">電力耗能</div><div><span id="analysis-power" class="value">--</span><span class="unit">kWh</span></div></div>
                            <div class="data-card small"><div class="title">空調耗能</div><div><span id="analysis-ac" class="value">--</span><span class="unit">kWh</span></div></div>
                            <div class="data-card small"><div class="title">照明耗能</div><div><span id="analysis-lighting" class="value">--</span><span class="unit">kWh</span></div></div>
                            <div class="data-card small"><div class="title">機房耗能</div><div><span id="analysis-server" class="value">--</span><span class="unit">kWh</span></div></div>
                            <div class="data-card small"><div class="title">其他耗能</div><div><span id="analysis-other" class="value">--</span><span class="unit">kWh</span></div></div>
                        </div>
                        <div class="chart-container pie-chart-container">
                            <div class="chart-wrapper">
                                <canvas id="consumption-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 「歷史紀錄」的內容面板  -->
                <div id="historical-records" class="tab-content">
                    <div class="record-block">
                        <h3 class="block-title">單日紀錄查詢</h3>
                            <div class="query-bar">
                            <input type="date" id="date-picker">
                            <button id="search-btn">搜尋</button>
                        </div>
                        <div id="historical-results" class="results-container">
                            <p class="placeholder-text">請選擇日期並點擊搜尋以載入數據</p>
                            <table id="results-table" class="hidden">
                                <thead><tr><th>項目</th><th>用電量 (kWh)</th></tr></thead>
                                <tbody></tbody>
                                <tfoot><tr><td><strong>總碳排放量 (公斤 CO2e)</strong></td><td id="carbon-emission-cell">--</td></tr></tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="record-block">
                        <h3 class="block-title">用電紀錄匯出</h3>
                        <div class="query-bar">
                            <input type="month" id="month-picker">
                            <button id="export-btn">匯出 Excel</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="data-section">
            <h2 class="section-title">水錶監控</h2>
            <div class="water-grid">
                <div class="water-summary">
                    <div class="data-card">
                        <div class="title">本日總用水度數</div>
                        <div class="card-main-content">
                            <div>
                                <span id="today-water" class="value">--</span><span class="unit">度</span>
                            </div>
                            <div class="sub-data-container">
                                <div class="sub-data-item">
                                    <span>住宅區:</span>
                                    <span id="today-water-res" class="sub-value">-- 度</span>
                                </div>
                                <div class="sub-data-item">
                                    <span>辦公區:</span>
                                    <span id="today-water-off" class="sub-value">-- 度</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="data-card">
                        <div class="title">本月總用水度數</div>
                        <div class="card-main-content">
                            <div>
                                <span id="month-water" class="value">--</span><span class="unit">度</span></div>
                            <div class="sub-data-container">
                                <div class="sub-data-item">
                                    <span>住宅區:</span>
                                    <span id="month-water-res" class="sub-value">-- 度</span>
                                </div>
                                <div class="sub-data-item">
                                    <span>辦公區:</span>
                                    <span id="month-water-off" class="sub-value">-- 度</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-container pie-chart-container">
                    <div class="chart-wrapper">
                        <canvas id="water-pie-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
        // --- 獲取 DOM 元素 ---
        const realtimePowerEl = document.getElementById('realtime-power');
        const todayKwhEl = document.getElementById('today-kwh');
        const monthKwhEl = document.getElementById('month-kwh');
        const todayWaterEl = document.getElementById('today-water');
        const monthWaterEl = document.getElementById('month-water');
        const datetimeContainer = document.getElementById('datetime-container');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const sidebarMenu = document.getElementById('sidebar-menu');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const todayWaterResEl = document.getElementById('today-water-res');
        const todayWaterOffEl = document.getElementById('today-water-off');
        const monthWaterResEl = document.getElementById('month-water-res');
        const monthWaterOffEl = document.getElementById('month-water-off');
        const ctxPie = document.getElementById('water-pie-chart').getContext('2d');
        const ctxConsumptionPie = document.getElementById('consumption-pie-chart').getContext('2d');
        const analysisPowerEl = document.getElementById('analysis-power');
        const analysisAcEl = document.getElementById('analysis-ac');
        const analysisLightingEl = document.getElementById('analysis-lighting');
        const analysisServerEl = document.getElementById('analysis-server');
        const analysisOtherEl = document.getElementById('analysis-other');
        const datePicker = document.getElementById('date-picker');
        const searchBtn = document.getElementById('search-btn');
        const historicalResults = document.getElementById('historical-results');
        const placeholderText = historicalResults.querySelector('.placeholder-text');
        const resultsTable = document.getElementById('results-table');
        const tableBody = resultsTable.querySelector('tbody');
        const carbonEmissionCell = document.getElementById('carbon-emission-cell');
        const monthPicker = document.getElementById('month-picker');
        const exportBtn = document.getElementById('export-btn');
        
        // --- 初始化圖表 ---
        const ctx = document.getElementById('hourly-chart').getContext('2d');
        let hourlyChart = null;       
        let currentPowerZone = 'total';
        let consumptionPieChart = null;
        // --- 圖表設定物件 ---
        const chartLabels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { color: '#8b949e' }, grid: { color: '#30363d' } }, x: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } } },
            plugins: { legend: { labels: { color: '#c9d1d9' } } }
        };
        // --- 初始化水力圓餅圖 ---
        const waterPieChart = new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: ['住宅區', '辦公區'],
                datasets: [{
                    label: '本日用水量 (度)',
                    data: [0, 0],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)', // 藍色
                        'rgba(255, 206, 86, 0.8)'  // 黃色
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    borderWidth: 1,                    
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '當日各區用水量分佈',
                        color: '#c9d1d9',
                        font: { size: 16 }
                    },
                    legend: {
                        labels: { color: '#c9d1d9' }
                    }
                }
            }
        });

        // 建立「折線圖」的函式
        function createLineChart(data) {
            if (hourlyChart) hourlyChart.destroy(); // 如果已有圖表，先銷毀它
            hourlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: '每小時用電總量 (kWh)',
                        data: data.total,
                        borderColor: 'rgba(0, 128, 255, 1)',
                        backgroundColor: 'rgba(88, 166, 255, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: chartOptions
            });
        }

        // 建立「堆疊長條圖」的函式
        function createStackedBarChart(data) {
            if (hourlyChart) hourlyChart.destroy();
            const stackedOptions = JSON.parse(JSON.stringify(chartOptions)); // 深拷貝一份設定
            stackedOptions.scales.x.stacked = true; // 開啟 X 軸堆疊
            stackedOptions.scales.y.stacked = true; // 開啟 Y 軸堆疊
            stackedOptions.scales.x.offset = true;

            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: '住宅區用電量',
                            data: data.residential,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)'
                        },
                        {
                            label: '辦公區用電量',
                            data: data.office,
                            backgroundColor: 'rgba(255, 206, 86, 0.8)'
                        }
                    ]
                },
                options: stackedOptions
            });
        }

        // 從 API 更新儀表板數據
        async function updateDashboard() {
            try {
                const response = await fetch('http://localhost:3000/api/energy');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                //console.log("從後端收到的原始數據:", JSON.stringify(data, null, 2));

                // 1. 更新電力卡片 (加上安全檢查)
                if (data && data.power && data.power[currentPowerZone]) {
                    const powerData = data.power[currentPowerZone];
                    if (powerData.realtime !== undefined) realtimePowerEl.textContent = powerData.realtime.toFixed(1);
                    if (powerData.today !== undefined) todayKwhEl.textContent = powerData.today.toLocaleString('en-US', { maximumFractionDigits: 1 });
                    if (powerData.month !== undefined) monthKwhEl.textContent = powerData.month.toLocaleString('en-US', { maximumFractionDigits: 1 });
                }

                // 2. 更新水力卡片 (加上安全檢查)
                if (data && data.water) {
                    if (data.water.todayTotal !== undefined) todayWaterEl.textContent = data.water.todayTotal.toFixed(1);
                    if (data.water.monthTotal !== undefined) monthWaterEl.textContent = data.water.monthTotal.toLocaleString('en-US', { maximumFractionDigits: 1 });
            
                    if (data.water.todayBreakdown) {
                        if (data.water.todayBreakdown.residential !== undefined) todayWaterResEl.textContent = `${data.water.todayBreakdown.residential.toFixed(1)} 度`;
                        if (data.water.todayBreakdown.office !== undefined) todayWaterOffEl.textContent = `${data.water.todayBreakdown.office.toFixed(1)} 度`;
                    }
            
                    if (data.water.monthBreakdown) {
                        if (data.water.monthBreakdown.residential !== undefined) monthWaterResEl.textContent = `${data.water.monthBreakdown.residential.toLocaleString('en-US', { maximumFractionDigits: 1 })} 度`;
                        if (data.water.monthBreakdown.office !== undefined) monthWaterOffEl.textContent = `${data.water.monthBreakdown.office.toLocaleString('en-US', { maximumFractionDigits: 1 })} 度`;
                    }
                }

                // 3. 更新用電量圖表 (加上安全檢查)
                if (data && data.hourlyData) {
                    if (!hourlyChart) { 
                        createStackedBarChart(data.hourlyData); 
                    } else if (hourlyChart.config.type === 'line' && data.hourlyData.total) { 
                        hourlyChart.data.datasets[0].data = data.hourlyData.total; 
                        hourlyChart.update('none'); 
                    } else if (hourlyChart.config.type === 'bar' && data.hourlyData.residential && data.hourlyData.office) { 
                        hourlyChart.data.datasets[0].data = data.hourlyData.residential; 
                        hourlyChart.data.datasets[1].data = data.hourlyData.office; 
                        hourlyChart.update('none'); 
                    }
                }
        
                // 4. 更新圓餅圖 (加上安全檢查)
                if (waterPieChart && data && data.water && data.water.todayBreakdown) {
                    waterPieChart.data.datasets[0].data = [
                        data.water.todayBreakdown.residential,
                        data.water.todayBreakdown.office
                    ];
                waterPieChart.update('none');
                }

                // +++ 5.耗能分析圓餅圖 ★★★ +++
                if (data.consumptionAnalysis) {
                        const analysisData = data.consumptionAnalysis;
                        analysisPowerEl.textContent = analysisData.power.toLocaleString('en-US', { maximumFractionDigits: 1 });
                        analysisAcEl.textContent = analysisData.ac.toLocaleString('en-US', { maximumFractionDigits: 1 });
                        analysisLightingEl.textContent = analysisData.lighting.toLocaleString('en-US', { maximumFractionDigits: 1 });
                        analysisServerEl.textContent = analysisData.serverRoom.toLocaleString('en-US', { maximumFractionDigits: 1 });
                        analysisOtherEl.textContent = analysisData.other.toLocaleString('en-US', { maximumFractionDigits: 1 });

                        const analysisChartData = Object.values(analysisData);
                        
                        if (!consumptionPieChart) {
                            // ★★★ 初始化一個帶有傳統圖例的標準圓餅圖 ★★★
                            consumptionPieChart = new Chart(ctxConsumptionPie, {
                                type: 'pie',
                                data: {
                                    labels: ['電力', '空調', '照明', '機房', '其他'],
                                    datasets: [{
                                        label: '耗能佔比 (kWh)',
                                        data: analysisChartData,
                                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: '本日各項設備耗能佔比',
                                            color: '#c9d1d9',
                                            font: { size: 22 }, // ★ 稍微加大標題字體
                                            padding: {
                                                bottom: 30 // ★ 增加標題與圖表之間的距離
                                            }
                                        },
                                        legend: {
                                            position: 'bottom',
                                            labels: {
                                                color: '#c9d1d9',
                                                padding: 60, // ★ 增加圖例與圖表之間的距離
                                                font: {
                                                size: 16 // ★ 加大圖例的字體大小
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        } else {
                            consumptionPieChart.data.datasets[0].data = analysisChartData;
                            consumptionPieChart.update('none');
                        }
                    }                                
            } catch (error) {
                console.error("更新儀表板數據失敗:", error);
            }
        }
        
        // +++ ▼歷史數據函式 ▼▼▼ +++
        function setupHistoricalRecords() {
            // 設定日期選擇器的預設值為今天
            datePicker.value = new Date().toISOString().split('T')[0];

            searchBtn.addEventListener('click', async () => {
                const selectedDate = datePicker.value;
                if (!selectedDate) {
                    alert('請選擇一個日期');
                    return;
                }

                // 顯示載入中訊息
                placeholderText.textContent = '正在載入數據...';
                placeholderText.classList.remove('hidden');
                resultsTable.classList.add('hidden');

                try {
                    const response = await fetch(`http://localhost:3000/api/historical-power?date=${selectedDate}`);
                    const data = await response.json();

                    // 清空舊的表格內容
                    tableBody.innerHTML = '';

                    // 建立表格內容
                    const rows = [
                        { label: '辦公區 - 電力', value: data.officeConsumption.power },
                        { label: '辦公區 - 空調', value: data.officeConsumption.ac },
                        { label: '辦公區 - 照明', value: data.officeConsumption.lighting },
                        { label: '辦公區 - 機房', value: data.officeConsumption.serverRoom },
                        { label: '辦公區 - 其他', value: data.officeConsumption.other },
                        { label: '<strong>辦公區總用電量</strong>', value: data.totalOfficeConsumption },
                        { label: '<strong>住宅區總用電量</strong>', value: data.residentialConsumption },
                        { label: '<strong>當日總用電量</strong>', value: data.totalConsumption },
                    ];

                    rows.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.label}</td>
                            <td>${row.value.toLocaleString('en-US', { maximumFractionDigits: 1 })} kWh</td>
                        `;
                        tableBody.appendChild(tr);
                    });

                    // 更新碳排放量
                    carbonEmissionCell.textContent = data.carbonEmission.toLocaleString('en-US', { maximumFractionDigits: 1 });

                    // 顯示表格
                    placeholderText.classList.add('hidden');
                    resultsTable.classList.remove('hidden');

                } catch (error) {
                    placeholderText.textContent = '載入數據失敗，請稍後再試。';
                    console.error("載入歷史數據失敗:", error);
                }
            });
        }

        function setupExportFeature() {
            // 設定月份選擇器的預設值為當前月份
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            monthPicker.value = `${year}-${month}`;

            exportBtn.addEventListener('click', async () => {
                const [selectedYear, selectedMonth] = monthPicker.value.split('-');
                if (!selectedYear || !selectedMonth) {
                    alert('請選擇一個有效的月份');
                    return;
                }

                // 禁用按鈕並顯示載入中
                exportBtn.disabled = true;
                exportBtn.textContent = '正在產生...';

                try {
                    // 1. 從後端獲取整個月的數據
                    const response = await fetch(`http://localhost:3000/api/monthly-power-report?year=${selectedYear}&month=${selectedMonth}`);
                    const monthlyData = await response.json();

                    // 2. 將 JSON 數據轉換為 Excel 工作表需要的格式
                    const dataForExcel = monthlyData.map(day => ({
                        '日期': day.date,
                        '辦公區-電力(kWh)': day.officeConsumption.power,
                        '辦公區-空調(kWh)': day.officeConsumption.ac,
                        '辦公區-照明(kWh)': day.officeConsumption.lighting,
                        '辦公區-機房(kWh)': day.officeConsumption.serverRoom,
                        '辦公區-其他(kWh)': day.officeConsumption.other,
                        '辦公區-總計(kWh)': day.totalOfficeConsumption,
                        '住宅區-總計(kWh)': day.residentialConsumption,
                        '當日總用電量(kWh)': day.totalConsumption,
                        '碳排放量(kg CO2e)': day.carbonEmission
                    }));

                    // 3. 使用 SheetJS 產生 Excel 檔案
                    const worksheet = XLSX.utils.json_to_sheet(dataForExcel);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "月度耗能報告");

                    // 4. 觸發下載
                    XLSX.writeFile(workbook, `興隆社宅_${selectedYear}-${selectedMonth}_耗能報告.xlsx`);

                } catch (error) {
                    console.error("匯出 Excel 失敗:", error);
                    alert("產生報告失敗，請查看主控台錯誤訊息。");
                } finally {
                    // 恢復按鈕狀態
                    exportBtn.disabled = false;
                    exportBtn.textContent = '匯出 Excel';
                }
            });
        }

        // 設定圖表切換按鈕的事件
        function setupChartToggle() {
            const lineBtn = document.getElementById('line-chart-btn');
            const barBtn = document.getElementById('bar-chart-btn');

            lineBtn.addEventListener('click', async () => {
                const response = await fetch('http://localhost:3000/api/energy');
                const data = await response.json();
                createLineChart(data.hourlyData);
                lineBtn.classList.add('active');
                barBtn.classList.remove('active');
            });
            barBtn.addEventListener('click', async () => {
                const response = await fetch('http://localhost:3000/api/energy');
                const data = await response.json();
                createStackedBarChart(data.hourlyData);
                barBtn.classList.add('active');
                lineBtn.classList.remove('active');
            });
        }

        function setupTabNavigation() {
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabContents = document.querySelectorAll('.tab-content');

            tabLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault(); // 阻止連結的預設跳轉行為

                    // 移除所有頁籤和內容的 active class
                    tabLinks.forEach(l => l.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // 為被點擊的頁籤和其對應的內容加上 active class
                    link.classList.add('active');
                    const targetContent = document.querySelector(link.getAttribute('href'));
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
        }

        function setupDataToggle() {
             const dataToggleContainer = document.querySelector('.data-section:first-of-type .chart-toggle');
            const dataToggleButtons = dataToggleContainer.querySelectorAll('.toggle-btn');

            dataToggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // 只移除「這組」按鈕的 active class
                    dataToggleButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    // 更新當前選中的區域
                    currentPowerZone = button.dataset.zone;

                    // 立刻重新抓取並更新儀表板數據
                    updateDashboard();
                });
            });
        }

        // --- UI 框架功能函式 ---
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            datetimeContainer.textContent = `${now.toLocaleDateString('zh-TW', dateOptions)} ${now.toLocaleTimeString('zh-TW', timeOptions)}`;
        }

        function setupSidebarMenu() {
            menuToggleBtn.addEventListener('click', () => sidebarMenu.classList.toggle('open'));
            closeMenuBtn.addEventListener('click', () => sidebarMenu.classList.remove('open'));
            document.addEventListener('click', (event) => {
                const isClickInsideMenu = sidebarMenu.contains(event.target) || menuToggleBtn.contains(event.target);
                if (sidebarMenu.classList.contains('open') && !isClickInsideMenu) {
                    sidebarMenu.classList.remove('open');
                }
            });
            document.querySelectorAll('.system-category > a').forEach(categoryLink => {
                const submenu = categoryLink.nextElementSibling;
                if (submenu && submenu.classList.contains('floor-submenu')) {
                    categoryLink.addEventListener('click', (event) => {
                        event.preventDefault();
                        categoryLink.parentElement.classList.toggle('active');
                        submenu.style.maxHeight = submenu.style.maxHeight ? null : submenu.scrollHeight + "px";
                    });
                }
            });
        }

        // 設定圖表切換按鈕的事件
        function setupChartToggle() {
            const lineBtn = document.getElementById('line-chart-btn');
            const barBtn = document.getElementById('bar-chart-btn');

            // 為「總量趨勢」按鈕新增點擊事件
            lineBtn.addEventListener('click', async () => {
                // 從後端獲取最新數據
                const response = await fetch('http://localhost:3000/api/energy');
                const data = await response.json();
                // 呼叫函式來建立「折線圖」
                createLineChart(data.hourlyData);

                // 更新按鈕的選中樣式
                lineBtn.classList.add('active');
                barBtn.classList.remove('active');
            });

            // 為「用量分佈」按鈕新增點擊事件
            barBtn.addEventListener('click', async () => {
                // 從後端獲取最新數據
                const response = await fetch('http://localhost:3000/api/energy');
                const data = await response.json();
                // 呼叫函式來建立「堆疊長條圖」
                createStackedBarChart(data.hourlyData);

                // 更新按鈕的選中樣式
                barBtn.classList.add('active');
                lineBtn.classList.remove('active');
            });
        }

        // --- 啟動所有功能 ---
        updateDashboard();
        setInterval(updateDashboard, 5000);
        updateDateTime();
        setInterval(updateDateTime, 1000);
        setupSidebarMenu();
        setupChartToggle();
        setupDataToggle();
        setupTabNavigation();
        setupHistoricalRecords();
        setupExportFeature();
        });
    </script>
    <footer id="page-footer">
        <span>v1.2.0</span> | <span>Copyright © 2025 KL </span>
    </footer>
</body>
</html>