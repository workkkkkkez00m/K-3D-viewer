<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電梯監控系統</title>
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/apple-touch-icon.png">
    <link rel="shortcut icon" href="../assets/favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- 基礎樣式 --- */
        body { margin: 0; font-family: 'Microsoft JhengHei', 'Heiti TC', sans-serif; overflow: hidden; background-color: #0d1117; color: #c9d1d9; }

        /* --- 框架 UI 樣式  --- */
        #top-banner {
            position: relative; top: 0; left: 0; width: 100%;
            background-color: rgba(0, 0, 0, 0.7); color: white;
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; box-sizing: border-box; z-index: 20;
        }
        #project-title { margin: 0; font-size: 22px; font-weight: 500; margin-left: 15px; }
        #datetime-container { font-size: 16px; }
        #menu-toggle-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0 10px; }
        #sidebar-menu { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background-color: #2c3e50; padding: 20px; box-sizing: border-box; z-index: 1000; transition: left 0.3s ease-in-out; }
        #sidebar-menu.open { left: 0; }
        #sidebar-menu h2 { color: white; margin-top: 50px; border-bottom: 1px solid #465a70; padding-bottom: 10px; }
        #sidebar-menu ul { list-style: none; padding: 0; margin-top: 20px;}
        #sidebar-menu li a { display: block; color: #ecf0f1; text-decoration: none; padding: 15px 10px; border-radius: 4px; transition: background-color 0.2s; }
        #sidebar-menu li a:hover { background-color: #34495e; }
        #close-menu-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 30px; font-weight: bold; line-height: 1; cursor: pointer; }
        #sidebar-menu .system-category > a { font-weight: bold; background-color: #1bdbed; color: white; }
        #sidebar-menu .system-category > a::after { content: '▼'; float: right; transition: transform 0.3s; }
        #sidebar-menu .system-category.active > a::after { transform: rotate(180deg); }
        .floor-submenu { list-style: none; padding-left: 20px; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        #back-to-home-btn { margin-top: 20px; padding-top: 20px !important; border-top: 1px solid #465a70; font-weight: bold; color: #1bdbed !important; }
        #back-to-home-btn:hover { background-color: #34495e !important; color: #1fecff !important; }
        /* 為能源管理和電梯監控系統按鈕添加適當間距 */
        #sidebar-menu li a[href*="energy"] {
            margin-bottom: 18px; /* 能源管理按鈕下方間距 */
        }
        /* 此頁面沒有3D操控，隱藏不需要的按鈕和提示 */
        #ui-container, #controls-helper, #floor-indicator { display: none; }
       
        /* 移除標題連結的預設樣式 */
        #home-link-title {
            color: inherit; /* 繼承父元素(header)的文字顏色，也就是白色 */
            text-decoration: none; /* 移除底線 */
            position: absolute; /* ★ 1. 讓標題脫離文檔流，進行絕對定位 */
            left: 50%;          /* ★ 2. 將標題的左側邊緣，對齊到父容器的中心線 */
            top: 50%;           /* ★ 3. 將標題的頂部邊緣，對齊到父容器的中心線 */
            transform: translate(-50%, -50%); /* ★ 4. 將標題向左、向上移動自身寬高的一半，實現完美置中 */
            width: 60%; /* 設定一個寬度，防止標題在小螢幕上與兩側元素重疊 */
            text-align: center;
        }             
        /*icon*/
        .header-right-items {
            display: flex;
            align-items: center; /* 讓日期時間和圖示垂直置中對齊 */
            gap: 15px; /* 在日期時間和圖示之間增加間距 */
        }
        /* 2. 右上角 Logo 圖示的樣式 */
        #logo-icon-right {
            height: 32px; /* 設定圖示的高度 */
            width: 32px;  /* 設定圖示的寬度 */
        }
        /* 頁腳的樣式 */
        #page-footer {
            position: fixed; 
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001; /* 確保它在最上層 (比側邊欄的 1000 還高) */
    
            color: rgba(255, 255, 255, 0.3); /* 半透明的白色文字 */
            font-size: 12px;
    
            /* 確保滑鼠可以穿透它，不會擋住下方的元素 */
            pointer-events: none; 
    
            /* 確保使用者無法選取文字 */
            user-select: none;
            -webkit-user-select: none;
        }
        /* --- ★★★ 全新的電梯儀表板樣式 ★★★ --- */
        #elevator-dashboard {
            position: absolute;
            top: 60px; /* 避開頂部橫幅 */
            left: 0;
            right: 0;
            bottom: 40px; /* 避開底部版權信息 */
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        /* --- 電梯儀表板樣式 --- */
        .elevator-unit {
            background-color: #161b22; border: 2px solid #30363d; border-radius: 8px;
            padding: 0; position: relative; width: 280px;
            min-height: 400px;
            perspective: 1000px;
        }
        .flipper {
            position: relative;
            width: 100%;
            height: calc(100% - 80px); /* 減去標題和狀態列的高度 */
            margin-top: 80px; /* 為標題和狀態列預留空間 */
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        /* 當 .elevator-unit 擁有 .flipped class 時，翻轉 .flipper */
        .elevator-unit.flipped .flipper {
            transform: rotateY(180deg);
        }
        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            background-color: #161b22;
            border: 2px solid #30363d;
            border-radius: 8px;
            border-top: none; /* 移除上邊框，因為上方有標題區 */
            border-top-left-radius: 0; /* 移除上方圓角 */
            border-top-right-radius: 0; /* 移除上方圓角 */
            padding: 10px;
            box-sizing: border-box;
        }
        .front {
            /* 正面內容：水平布局（樓層側 + 電梯側） */
            gap: 10px;
        }
        .back {
            /* 背面內容：垂直布局（進階功能），預先翻轉 180 度 */
            transform: rotateY(180deg);
            flex-direction: column;
        }
        /* 背面進階功能的樣式 */
        .advanced-controls {
            padding-top: 20px; /* 減少上方間距 */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .adv-data-item {
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            padding: 5px 0;
            border-bottom: 1px solid #21262d;
        }
        .adv-data-item .label { color: #8b949e; }
        .adv-data-item .value { font-weight: bold; }
        .adv-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .adv-btn {
            background-color: #21262d; border: 1px solid #30363d;
            color: #c9d1d9; padding: 10px; border-radius: 6px;
            cursor: pointer; transition: background-color 0.2s;
            /* 確保按鈕內的文字不會干擾點擊事件 */
            position: relative;
            z-index: 1;
        }
        .adv-btn:hover { background-color: #30363d; }
        .adv-btn * {
            /* 確保按鈕內所有子元素的點擊事件都傳遞給父按鈕 */
            pointer-events: none;
        }
        .manual-controls { text-align: center; }
        .manual-controls button {
            font-size: 24px; width: 50px; height: 50px;
            margin: 5px;
        }
        
        /* 電梯標題 */
        .elevator-header {
            text-align: center;
            padding: 8px;
            font-weight: bold;
            color: white;
            position: absolute;
            top: 0; left: 0; right: 0;
            background-color: #21262d;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            border-bottom: 1px solid #30363d;
            font-size: 15px;
        }
        
        /* 樓層側 */
        .floors-side {
            flex: 1;
            display: flex;
            flex-direction: column-reverse;
            margin-top: 40px;
            border-right: 1px solid #30363d;
            padding-right: 8px;
        }
        
        /* 車廂動畫側 */
        .elevator-side {
            flex: 0 0 80px;
            display: flex;
            flex-direction: column-reverse;
            margin-top: 40px;
            position: relative;
            background-color: #0d1117;
            border-radius: 4px;
            border: 1px solid #21262d;
        }
        
        .floor {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 8px;
            border-bottom: 1px dashed #30363d;
            transition: all 0.3s ease;
            min-height: 35px;
        }
        .floor:last-child { border-bottom: 1px dashed #30363d; }
        .floor-name { font-size: 16px; font-weight: bold; color: #d1d5d8; }
        .hall-call-buttons button {
            background: none; border: none; color: #65717e;
            font-size: 16px; cursor: default;
        }
        .hall-call-buttons button.active { color: #f1c40f; }

        /* 車廂側樓層標示 */
        .shaft-floor {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 1px solid #21262d;
            font-size: 12px;
            color: #6e7681;
            transition: all 0.3s ease;
            min-height: 35px;
        }
        .shaft-floor:last-child { border-bottom: 1px solid #21262d; }

        /* 電梯車廂 */
        .elevator-car {
            position: absolute;
            bottom: 0;
            left: 2px; right: 2px;
            height: 12.5%;
            background-color: #6e7681;
            border: 2px solid #c9d1d9;
            border-radius: 3px;
            box-sizing: border-box;
            transition: bottom 1s ease-in-out;
            z-index: 10;
            display: flex;
            overflow: hidden;
        }

        /* 車門 */
        .elevator-door {
            width: 50%;
            height: 100%;
            background-color: #adb5bd;
            border: 1px solid #8b949e;
            box-sizing: border-box;
            transition: transform 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #495057;
        }
        
        .elevator-car.door-open .elevator-door.left { 
            transform: translateX(-100%); 
        }
        .elevator-car.door-open .elevator-door.right { 
            transform: translateX(100%); 
        }

        /* 車廂狀態顯示 */
        .car-status {
            position: absolute;
            top: 1px;
            left: 50%;
            transform: translateX(-50%);
            color: #212529;
            font-weight: bold;
            font-size: 8px;
            z-index: 11;
            background: rgba(255,255,255,0.9);
            padding: 1px 2px;
            border-radius: 2px;
        }

        .shaft-floor.elevator-here {
            background-color: rgba(88, 166, 255, 0.3) !important;
            color: #58a6ff !important;
            font-weight: bold;
            box-shadow: inset 0 0 8px rgba(88, 166, 255, 0.5);
        }

        /* 車廂內叫車樓層顯示（改用藍色框） */
        .shaft-floor.car-call {
            background-color: rgba(88, 166, 255, 0.3) !important;
            color: #58a6ff !important;
            font-weight: bold;
            border: 1px solid #58a6ff;
            box-shadow: inset 0 0 8px rgba(88, 166, 255, 0.5);
        }

        /* ★★★ 狀態列樣式 ★★★ */
        .status-bar {
            position: absolute;
            top: 40px; /* 剛好在 header 下方 */
            left: 10px; right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            z-index: 5;
        }
        
        /* 緊急呼叫按鈕樣式 */
        .emergency-call {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #8b949e;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        
        .emergency-call-light {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #404040;
            border: 1px solid #555;
            transition: all 0.3s ease;
        }
        
        .emergency-call.active {
            background-color: #2d1b1b;
            border-color: #e74c3c;
            color: #ff8a80;
            font-weight: bold;
            animation: pulse-red 1.5s infinite; /* ★ 將靜態陰影改為閃爍動畫 */
        }
        
        .emergency-call.active .emergency-call-light {
            background-color: #e74c3c;
            border-color: #ff6b6b;
            box-shadow: 0 0 6px #e74c3c, inset 0 0 6px #ff4444;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 79, 59, 0.71);
            }
            70% {
                box-shadow: 0 0 0 12px rgba(231, 77, 60, 0.15);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
                }
        }
        
        /* 運轉狀態按鈕樣式 */
        .run-status {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 4px;
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .run-status.fault { 
            background-color: #2d2519;
            border-color: #FFC107;
            color: #FFC107; 
            box-shadow: 0 0 6px rgba(255, 193, 7, 0.3);
        }
        
        .run-status.power-off { 
            background-color: #2d1b1b;
            border-color: #f5412d;
            color: #e74c3c; 
            box-shadow: 0 0 6px rgba(231, 76, 60, 0.3);
        }
        
        .run-status.standby { 
            background-color: #1f2329;
            border-color: #6b7280;
            color: #8b949e; 
        }
        
        .run-status.normal { 
            background-color: #1b2d1f;
            border-color: #2ecc71;
            color: #2ecc71; 
            box-shadow: 0 0 6px rgba(46, 204, 113, 0.3);
        }

        /* 調整樓層區塊的上邊距 */
        .floors-side, .elevator-side {
            margin-top: 0; /* 移除上邊距，因為標題和狀態列已經在外面 */
        }

        /* ★★★ Modal 樣式 ★★★ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: #1e2328;  /* 改為稍微亮一點的深灰色 */
            border: 2px solid #58a6ff;  /* 改為藍色邊框 */
            border-radius: 8px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 20px rgba(88, 166, 255, 0.3); /* 添加藍色光暈 */
        }
        
        .modal-content h3 {
            margin-top: 0;
            color: #58a6ff;  /* 改為藍色標題 */
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .modal-content p {
            color: #c9d1d9;  /* 改為更亮的白色文字 */
            margin-bottom: 20px;
        }
        
        .modal-content input[type="month"] {
            width: 100%;
            padding: 10px;
            background-color: #0d1117;  /* 更深的背景色 */
            border: 1px solid #58a6ff;  /* 藍色邊框 */
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center; /* 讓輸入內容置中 */
            box-sizing: border-box; /* 確保 width: 100% 包含 padding 和 border */
            color-scheme: dark; /* 使用深色主題 */
            accent-color: #58a6ff; /* 設定強調色為藍色 */
        }
        
        .modal-content input[type="month"]:focus {
            outline: none;
            border-color: #79c0ff;  /* 聚焦時更亮的藍色 */
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .modal-buttons .adv-btn {
            flex: 1;
            max-width: 120px;
            background-color: #21262d;
            border: 1px solid #58a6ff;  /* 藍色邊框 */
            color: #58a6ff;  /* 藍色文字 */
        }
        
        .modal-buttons .adv-btn:hover {
            background-color: rgba(88, 166, 255, 0.1);  /* 藍色半透明背景 */
            border-color: #79c0ff;  /* 更亮的藍色邊框 */
            color: #79c0ff;  /* 更亮的藍色文字 */
        }
        
        /* 匯出按鈕特殊樣式 */
        .modal-buttons #modal-export-btn {
            background-color: #238636;  /* 綠色背景 */
            border-color: #2ea043;  /* 綠色邊框 */
            color: #ffffff;  /* 白色文字 */
        }
        
        .modal-buttons #modal-export-btn:hover {
            background-color: #2ea043;  /* 更亮的綠色 */
            border-color: #46954a;
        }
        /* 設定按鈕的專屬樣式 */
        .settings-btn {
            position: absolute;
            top: 2px; /* 稍微增加與邊緣的距離 */
            right: 2px;
            z-index: 12;
    
            /* --- ★ 修改大小 --- */
            width: 30px;
            height: 30px;
            font-size: 20px; /* 齒輪圖示的大小 */

            /* --- ★修改顏色 --- */
            background-color: #52586068; /* 按鈕背景色 */
            color: #a9b0b9;            /* 齒輪的顏色 */
            border: 1px solid #484f58;

            /* 其他樣式 */
            padding: 0; /* 移除內邊距以讓圖示置中 */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background-color: #484f58;
            color: #c9d1d9;
        }


    </style>
</head>
<body>
    <header id="top-banner">
        <button id="menu-toggle-btn" title="展開選單">☰</button>
        <a href="https://workkkkkkez00m.github.io/K-3D-viewer/index.html" id="home-link-title">
            <h1 id="project-title">智慧住宅中央監控系統 </h1>
        </a>
        <div class="header-right-items">
            <div id="datetime-container"></div>
            <img src="../assets/favicon-32x32.png" id="logo-icon-right" alt="系統圖示">
        </div>
    </header>

    <nav id="sidebar-menu">
        <button id="close-menu-btn">&times;</button>
        <h2>系統選單</h2>
        <ul>            
            <li class="system-category">
                <a href="#">防盜及求救系統</a>
                <ul class="floor-submenu">
                    <li><a href="../theft_prevention/1f.html">1F</a></li>
                    <li><a href="../theft_prevention/2f.html">2F</a></li>
                    <li><a href="../theft_prevention/3f.html">3F</a></li>
                    <li><a href="../theft_prevention/4f.html">4F</a></li>
                    <li><a href="../theft_prevention/5f.html">5F</a></li>
                </ul>
            </li>
            <li class="system-category">
                <a href="#">攝影監視系統</a>
                <ul class="floor-submenu">
                    <li><a href="../cctv/1f.html">1F</a></li>
                    <li><a href="../cctv/2f.html">2F</a></li>
                    <li><a href="../cctv/3f.html">3F</a></li>
                    <li><a href="../cctv/4f.html">4F</a></li>
                    <li><a href="../cctv/5f.html">5F</a></li>
                </ul>
            </li>
            <li class="system-category">
                <a href="#">門禁保全系統</a>
                <ul class="floor-submenu">
                     <li><a href="../access_control/1f.html">1F</a></li>
                    <li><a href="../access_control/2f.html">2F</a></li>
                    <li><a href="../access_control/3f.html">3F</a></li>
                    <li><a href="../access_control/4f.html">4F</a></li>
                    <li><a href="../access_control/5f.html">5F</a></li>
                </ul>
            </li>
            <li class="system-category">
                <a href="#">影像對講系統</a>
                <ul class="floor-submenu">
                    <li><a href="../video_intercom/1f.html">1F</a></li>
                    <li><a href="../video_intercom/2f.html">2F</a></li>
                    <li><a href="../video_intercom/3f.html">3F</a></li>
                    <li><a href="../video_intercom/4f.html">4F</a></li>
                    <li><a href="../video_intercom/5f.html">5F</a></li>
                </ul>
            </li>
            <li class="system-category">
                <a href="#">消防火警系統</a>
                <ul class="floor-submenu">
                    <li><a href="../fire_alarm/1f.html">1F</a></li>
                    <li><a href="../fire_alarm/2f.html">2F</a></li>
                    <li><a href="../fire_alarm/3f.html">3F</a></li>
                    <li><a href="../fire_alarm/4f.html">4F</a></li>
                    <li><a href="../fire_alarm/5f.html">5F</a></li>
                </ul>
            </li>
            <li class="system-category">
                <a href="#">給排水系統</a>
                <ul class="floor-submenu">
                   <li><a href="../plumbing_drainage/b3f.html">B3F</a></li>                   
                </ul>
            </li>
            <li class="system-category">
                <a href="#">停車管理系統</a>
                <ul class="floor-submenu">
                    <li><a href="../parking_management/b1f.html">B1F</a></li>
                    <li><a href="../parking_management/b2f.html">B2F</a></li>
                    <li><a href="../parking_management/b3f.html">B3F</a></li>                   
                </ul>
            </li>   
            <li><a href="../energy/index.html" style="background-color: #007bff; font-weight: bold;">能源管理儀表板</a></li>            
            <li><a href="../elevator_management/index.html" style="background-color: #007bff; font-weight: bold;">電梯監控系統</a></li>
            <li><a id="back-to-home-btn" href="../index.html">‹ 回首頁</a></li>
        </ul>
    </nav>

    <main id="content-wrapper">
        <div id="elevator-dashboard">
        </div>    
    </main>
    <!-- 紀錄匯出 Modal -->
    <div id="export-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">匯出電梯紀錄</h3>
            <p id="modal-subtitle"></p>
            <input type="month" id="month-picker">
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="adv-btn">取消</button>
                <button id="modal-export-btn" class="adv-btn">匯出</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 全局樓層列表定義（從低樓層到高樓層） ---
            const allFloors = ['B3F', 'B2F', 'B1F', '1F', '2F', '3F', '4F', '5F'];
            
            // --- 獲取基本 DOM 元素 ---
            const datetimeContainer = document.getElementById('datetime-container');
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const sidebarMenu = document.getElementById('sidebar-menu');
            const closeMenuBtn = document.getElementById('close-menu-btn');
            const dashboard = document.getElementById('elevator-dashboard');
            const exportModal = document.getElementById('export-modal');
            const modalSubtitle = document.getElementById('modal-subtitle');
            const monthPicker = document.getElementById('month-picker');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalExportBtn = document.getElementById('modal-export-btn');
            let currentExportElevator = null;

            // --- UI 框架功能函式 ---
            function updateDateTime() {
                const now = new Date();
                const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
                datetimeContainer.textContent = `${now.toLocaleDateString('zh-TW', dateOptions)} ${now.toLocaleTimeString('zh-TW', timeOptions)}`;
            }

            function setupSidebarMenu() {
                menuToggleBtn.addEventListener('click', () => sidebarMenu.classList.toggle('open'));
                closeMenuBtn.addEventListener('click', () => sidebarMenu.classList.remove('open'));
                document.addEventListener('click', (event) => {
                    const isClickInsideMenu = sidebarMenu.contains(event.target) || menuToggleBtn.contains(event.target);
                    if (sidebarMenu.classList.contains('open') && !isClickInsideMenu) {
                        sidebarMenu.classList.remove('open');
                    }
                });
                document.querySelectorAll('.system-category > a').forEach(categoryLink => {
                    const submenu = categoryLink.nextElementSibling;
                    if (submenu && submenu.classList.contains('floor-submenu')) {
                        categoryLink.addEventListener('click', (event) => {
                            event.preventDefault();
                            categoryLink.parentElement.classList.toggle('active');
                            submenu.style.maxHeight = submenu.style.maxHeight ? null : submenu.scrollHeight + "px";
                        });
                    }
                });
            }

            async function updateElevatorStatus() {
            try {
                const response = await fetch('http://localhost:3000/api/elevators');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const elevatorsData = await response.json();

                if (dashboard.children.length === 0) {
                    createElevatorUI(elevatorsData);
                }

                elevatorsData.forEach(data => {
                    const unit = document.getElementById(`elevator-unit-${data.id}`);
                    if (!unit) return;
                    
                    // 檢查是否處於手動模式
                    const isManualMode = unit.dataset.manualMode === 'true';
                    
                    // 樓層側和電梯側現在在 .front 容器內
                    const frontContainer = unit.querySelector('.front');
                    const floorsSide = frontContainer.querySelector('.floors-side');
                    const elevatorSide = frontContainer.querySelector('.elevator-side');
                    
                    if (!floorsSide || !elevatorSide) return;
                    
                    const car = elevatorSide.querySelector('.elevator-car');
                    const carStatus = elevatorSide.querySelector('.car-status');

                    // 獲取背面卡片的數據元素
                    const advCarFloor = unit.querySelector('.adv-car-floor');
                    const advRunTime = unit.querySelector('.adv-run-time');
                    const advStartupCount = unit.querySelector('.adv-startup-count');
                    
                    // ★★★ 計算電梯位置 ★★★
                    const currentGlobalIndex = allFloors.indexOf(data.currentFloor);
                    const floorHeightPercentage = 100 / allFloors.length;

                    // 1. 更新電梯車廂位置
                    car.style.bottom = `${currentGlobalIndex * floorHeightPercentage}%`;
                    car.style.height = `${floorHeightPercentage}%`;

                    // 2. 更新車廂狀態顯示
                    let directionText = '';
                    if(data.direction === 'up') directionText = '▲';
                    if(data.direction === 'down') directionText = '▼';
                    carStatus.textContent = `${data.currentFloor} ${directionText}`;

                    // 3. 更新車門狀態
                    car.classList.toggle('door-open', data.doorStatus === 'open');

                    // 4. 清除所有樓層的電梯效果
                    floorsSide.querySelectorAll('.floor').forEach(floor => {
                        floor.classList.remove('elevator-here');
                    });
                    elevatorSide.querySelectorAll('.shaft-floor').forEach(floor => {
                        floor.classList.remove('elevator-here', 'car-call');
                    });

                    // 5. 顯示車廂內叫車樓層（電梯井右側藍色框）
                    if (data.carCalls && data.carCalls.length > 0) {
                        data.carCalls.forEach(callFloor => {
                            const shaftFloorEl = elevatorSide.querySelector(`[data-floor-name="${callFloor}"]`);
                            if (shaftFloorEl && callFloor !== data.currentFloor) {
                                shaftFloorEl.classList.add('car-call');
                            }
                        });
                    }

                    // 6. 更新樓層叫車燈（大廳叫車）
                    floorsSide.querySelectorAll('.hall-call-buttons button').forEach(btn => btn.classList.remove('active'));
                    data.hallCalls.forEach(call => {
                        const floorEl = floorsSide.querySelector(`[data-floor-name="${call.floor}"]`);
                        if(floorEl) {
                            const btn = floorEl.querySelector(`[data-direction="${call.direction}"]`);
                            if(btn) btn.classList.add('active');
                        }
                    });

                    // ★ 更新背面卡片的數據
                    advCarFloor.textContent = data.currentFloor;
                    advRunTime.textContent = `${data.runTime} 分鐘`;
                    advStartupCount.textContent = `${data.startupCount} 次`;

                    // ★★★ 更新狀態列 ★★★
                    const emergencyCallEl = unit.querySelector('.emergency-call');
                    const runStatusEl = unit.querySelector('.run-status');
                    
                    // 緊急呼叫狀態不受手動模式影響
                    emergencyCallEl.classList.toggle('active', data.emergencyCall);
                    
                    // 只有在非手動模式時才更新運轉狀態
                    if (!isManualMode) {
                        runStatusEl.textContent = data.runStatus;
                        runStatusEl.className = 'run-status'; // 先重置 class
                        runStatusEl.style.backgroundColor = '';
                        runStatusEl.style.borderColor = '';
                        runStatusEl.style.color = '';
                        runStatusEl.style.boxShadow = '';
                        
                        if (data.runStatus === '電梯故障') runStatusEl.classList.add('fault');
                        // 只有五號電梯（緊急電梯）才會有停電運轉狀態
                        if (data.runStatus === '停電運轉' && data.id === 5) runStatusEl.classList.add('power-off');
                        if (data.runStatus === '自動休止') runStatusEl.classList.add('standby');
                        if (data.runStatus === '自動運轉') runStatusEl.classList.add('normal');
                    }

                });

            } catch (error) {
                console.error("更新電梯狀態失敗:", error);
                // 顯示詳細錯誤信息到儀表板
                if (dashboard.children.length === 0) {
                    dashboard.innerHTML = `
                        <div style="color: #ff6b6b; text-align: center; padding: 50px; font-size: 18px;">
                            無法連接到電梯 API 伺服器<br>
                            <small>請確認 API 服務正在運行</small><br><br>
                            <div style="background-color: #2d1b1b; border: 1px solid #e74c3c; border-radius: 6px; padding: 15px; margin-top: 20px; font-size: 12px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                                <strong>錯誤詳情：</strong><br>
                                ${error.message}<br><br>
                                <strong>可能的解決方案：</strong><br>
                                1. 確認 API 服務器是否在 localhost:3000 運行<br>
                                2. 檢查網路連接<br>
                                3. 確認 CORS 設定是否正確<br>
                                4. 查看瀏覽器開發者工具的 Network 標籤
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // 第一次建立電梯 UI 的函式
        function createElevatorUI(elevatorsData) {
            dashboard.innerHTML = '';
            elevatorsData.forEach(data => {
                // 創建電梯單元容器
                const elevatorUnit = document.createElement('div');
                elevatorUnit.className = 'elevator-unit';
                elevatorUnit.id = `elevator-unit-${data.id}`;

                // 建立樓層信息和車廂側標示
                let floorsHTML = '';
                let shaftFloorsHTML = '';
                allFloors.forEach(floorName => {
                    if (data.serviceFloors.includes(floorName)) {
                        // 樓層信息側
                        floorsHTML += `
                            <div class="floor" data-floor-name="${floorName}">
                                <span class="floor-name">${floorName}</span>
                                <div class="hall-call-buttons">
                                    ${floorName !== '5F' ? `<button data-direction="up">▲</button>` : '<span></span>'}
                                    ${floorName !== 'B3F' ? `<button data-direction="down">▼</button>` : '<span></span>'}
                                </div>
                            </div>
                        `;
                        // 車廂側樓層標示
                        shaftFloorsHTML += `<div class="shaft-floor" data-floor-name="${floorName}">${floorName}</div>`;
                    } else {
                        floorsHTML += `<div class="floor" style="background-color: transparent;"></div>`;
                        shaftFloorsHTML += `<div class="shaft-floor"></div>`;
                    }
                });

                // 設置完整的電梯HTML結構
                elevatorUnit.innerHTML = `
                    <div class="elevator-header">${data.name}</div>
                    <div class="status-bar">
                        <div class="emergency-call">
                            <div class="emergency-call-light"></div>
                            <span>緊急呼叫</span>
                        </div>
                        <div class="run-status"></div>
                    </div>
                    <div class="flipper">
                        <div class="front">
                            <div class="floors-side">
                                ${floorsHTML}
                            </div>
                            <div class="elevator-side">
                                ${shaftFloorsHTML}
                                <div class="elevator-car">
                                    <div class="car-status"></div>
                                    <div class="elevator-door left">◀</div>
                                    <div class="elevator-door right">▶</div>
                                </div>
                            </div>
                        </div>
                        <div class="back">
                            <div class="advanced-controls">
                                <div class="adv-data-item">
                                    <span class="label">車廂樓層</span>
                                    <span class="value adv-car-floor">--</span>
                                </div>
                                <div class="adv-data-item">
                                    <span class="label">本日運轉時間</span>
                                    <span class="value adv-run-time">--</span>
                                </div>
                                <div class="adv-data-item">
                                    <span class="label">本日啟動次數</span>
                                    <span class="value adv-startup-count">--</span>
                                </div>
                                <div class="adv-buttons">
                                    <button class="adv-btn">紀錄匯出</button>
                                    <button class="adv-btn manual-toggle">手動模式</button>
                                </div>
                                <div class="manual-controls" style="display: none;">
                                    <button class="adv-btn">▲</button>
                                    <button class="adv-btn">■</button>
                                    <button class="adv-btn">▼</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="adv-btn settings-btn">⚙️</button>
                `;
                
                // 為設定按鈕新增翻轉事件
                elevatorUnit.querySelector('.settings-btn').addEventListener('click', () => {
                    elevatorUnit.classList.toggle('flipped');
                });
                
                // ★ 為紀錄匯出按鈕新增事件
                const exportBtn = elevatorUnit.querySelector('.adv-buttons button:first-child');
                exportBtn.addEventListener('click', () => {
                    openExportModal(data);
                });

                // 為手動模式按鈕添加切換功能
                const manualToggleBtn = elevatorUnit.querySelector('.manual-toggle');
                const manualControls = elevatorUnit.querySelector('.manual-controls');
                
                manualToggleBtn.addEventListener('click', () => {
                    const isVisible = manualControls.style.display !== 'none';
                    const isManualMode = !isVisible;
                    
                    // 切換手動控制按鈕顯示
                    manualControls.style.display = isVisible ? 'none' : 'block';
                    manualToggleBtn.textContent = isVisible ? '手動模式' : '關閉手動';
                    manualToggleBtn.style.backgroundColor = isVisible ? '#21262d' : '#2d1b2d';
                    manualToggleBtn.style.borderColor = isVisible ? '#30363d' : '#8b5cf6';
                    manualToggleBtn.style.color = isVisible ? '#c9d1d9' : '#c084fc';
                    
                    // 設置手動模式標記
                    elevatorUnit.dataset.manualMode = isManualMode;
                    
                    // 更新前面的運轉狀態顯示
                    const runStatusEl = elevatorUnit.querySelector('.run-status');
                    if (isManualMode) {
                        runStatusEl.textContent = '手動運轉';
                        runStatusEl.className = 'run-status';
                        runStatusEl.style.backgroundColor = '#2d1b2d';
                        runStatusEl.style.borderColor = '#8b5cf6';
                        runStatusEl.style.color = '#c084fc';
                        runStatusEl.style.boxShadow = '0 0 6px rgba(139, 92, 246, 0.3)';
                    }
                    // 如果關閉手動模式，狀態會在下次API更新時恢復
                });

                // 添加到儀表板
                dashboard.appendChild(elevatorUnit);
            });
        }

        // ★★★ 全新的紀錄匯出相關函式 ★★★
        function openExportModal(elevatorData) {
            currentExportElevator = elevatorData;
            modalSubtitle.textContent = `正在為 ${elevatorData.name} 選擇匯出月份`;
            
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            monthPicker.value = `${year}-${month}`;
            
            exportModal.classList.add('visible');
        }

        function closeExportModal() {
            exportModal.classList.remove('visible');
            currentExportElevator = null;
        }

        async function handleExport() {
            if (!currentExportElevator) return;

            const [year, month] = monthPicker.value.split('-');
            const elevatorId = currentExportElevator.id;
            
            modalExportBtn.textContent = '正在產生...';
            modalExportBtn.disabled = true;

            try {
                console.log(`正在請求報告數據: year=${year}, month=${month}, elevatorId=${elevatorId}`);
                const response = await fetch(`http://localhost:3000/api/elevators/report?year=${year}&month=${month}&elevatorId=${elevatorId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}`);
                }
                
                const reportData = await response.json();
                console.log('收到報告數據:', reportData);

                // 檢查數據結構
                if (!reportData.dailySummaries || !reportData.eventLogs) {
                    throw new Error('報告數據格式不正確');
                }

                const wb = XLSX.utils.book_new();
                const summaryWS = XLSX.utils.json_to_sheet(reportData.dailySummaries);
                const logWS = XLSX.utils.json_to_sheet(reportData.eventLogs);

                XLSX.utils.book_append_sheet(wb, summaryWS, "每日摘要");
                XLSX.utils.book_append_sheet(wb, logWS, "事件紀錄");

                XLSX.writeFile(wb, `${currentExportElevator.name}_${year}-${month}_營運報告.xlsx`);
                
                console.log('Excel 文件已成功生成');
            } catch (error) {
                console.error("匯出報告失敗:", error);
                let errorMessage = "產生報告失敗";
                
                if (error.message.includes('HTTP error')) {
                    errorMessage = "API 服務器錯誤，請檢查服務器狀態";
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = "無法連接到 API 服務器";
                } else if (error.message.includes('報告數據格式不正確')) {
                    errorMessage = "服務器返回的數據格式有誤";
                }
                
                alert(`${errorMessage}\n\n詳細錯誤：${error.message}`);
            } finally {
                modalExportBtn.textContent = '匯出';
                modalExportBtn.disabled = false;
                closeExportModal();
            }
        }

        // --- 事件監聽 ---
        modalCancelBtn.addEventListener('click', closeExportModal);
        modalExportBtn.addEventListener('click', handleExport);

            // --- 啟動基本功能 ---
            updateDateTime();
            setInterval(updateDateTime, 1000);
            setupSidebarMenu();
            updateElevatorStatus();
            setInterval(updateElevatorStatus, 2000);
        });
    </script>
    <footer id="page-footer">
        <span>v1.2.0</span> | <span>Copyright © 2025 KL </span>
    </footer>
</body>
</html>